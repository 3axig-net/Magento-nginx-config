## Media location
location /media/ {
    ## Product images with resizing - direct match for catalog product images
    location ~* ^/media/catalog/product/.+\.(jpg|jpeg|png|webp|gif|svg)$ {
        expires max;
        add_header Cache-Control "public";
        
        ## Product image not found placeholder
        error_page 404 =404 /media/catalog/product/placeholder/default/placeholder.jpg;
        
        ## Preset default product image size
        set $width "265";
        set $height "265";
        
        ## Set image size from parameters
        if ($arg_width != '') { set $width $arg_width; }
        if ($arg_height != '') { set $height $arg_height; }
        
        ## Limit image size to prevent abuse
        if ($width ~ "^[0-9]{4}$") { return 404; }
        
        ## Cache headers
        add_header X-Imgproxy-Cache $upstream_cache_status;
        
        ## Proxy product images to imgproxy service
        set $resize "rs:fit:$width:$height";
        set $watermark "wm:0.3:soea:0:0:0.10";
        set $image_path "plain/local:/$uri";
        set $format "@webp";

        proxy_pass http://imgproxy/insecure/$resize/$watermark/$image_path$format;
        
        ## Cache settings
        proxy_cache imgproxy;
        proxy_cache_key "$scheme$request_method$host$uri$width$height";
        proxy_cache_valid 200 35d;
        proxy_cache_valid 404 1h;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;
    }
    
    ## All other images (non-product) - css, js, etc from media.
    location ~* \.(jpg|jpeg|png|webp|gif|svg|swf|eot|ttf|otf|woff|woff2|js|css|ico|txt)$ {
        expires max;
        add_header Cache-Control "public";
        proxy_pass http://nginx;
    }
    ## Default media handler for other files
    proxy_pass http://nginx;
}

	
